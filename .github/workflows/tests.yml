name: Robot Tests

on:
  pull_request:

jobs:
  robot-tests:
    runs-on: ubuntu-latest
    container:
      # Python 3.13 base (GLIBC compatible) for Linux
      image: python:3.13-bullseye

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install system dependencies needed for Robot Framework Browser (Playwright)
      - name: Install system dependencies for browsers
        run: |
          apt-get update
          apt-get install -y \
            curl wget unzip git libgtk-4-1 libgraphene-1.0-0 libwoff2dec1 \
            libvpx9 libevent-2.1-7 libopus0 gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-gl \
            libflite1 libavif16 libharfbuzz-icu0 libsecret-1-0 \
            libhyphen0 libmanette-0.2-0 libgles2-mesa libx264-163

      # Install Node.js 24
      - name: Set up Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_24.x | bash -
          apt-get install -y nodejs

      # Upgrade pip and install Robot Framework + libraries
      - name: Install Robot Framework and libraries
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-test.txt

      # Build your project / install local package
      - name: Install/Build project
        run: |
          bash scripts/install.sh

      # Initialize Robot Framework Browser (downloads Playwright browsers)
      - name: Initialize Browser library
        run: |
          rfbrowser init

      # Run Robot Framework tests with pabot
      - name: Run Robot tests
        id: robot
        run: |
          pabot --pabotlib --testlevelsplit --artifacts png,jpg \
                --artifactsinsubfolders --processes 4 -d results ./atest/testsuites/*.robot
        continue-on-error: true

      # Upload test results even if tests fail
      - name: Upload Robot logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results
          path: results/

      # Fail workflow if tests failed
      - name: Fail workflow if robot tests failed
        if: steps.robot.outcome == 'failure'
        run: |
          echo "Robot tests failed."
          exit 1
